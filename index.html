<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>CARO V14 - FULL CODE RESTORE</title>
    <style>
        body { background: #050505; color: #fff; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        #board { display: grid; grid-template-columns: repeat(12, 38px); gap: 2px; background: #111; padding: 12px; border-radius: 15px; border: 4px solid #00ff88; box-shadow: 0 0 60px rgba(0,255,136,0.3); }
        .cell { width: 38px; height: 38px; background: #000; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: 900; cursor: pointer; transition: 0.1s; border-radius: 4px; border: 1px solid #222; }
        .cell:hover { background: #111; box-shadow: inset 0 0 15px #00ff88; }
        .cell.X { color: #ff4444; text-shadow: 0 0 10px #ff4444; }
        .cell.O { color: #00d2ff; text-shadow: 0 0 10px #00d2ff; }
        .last-move { border: 2px solid #fff !important; box-shadow: 0 0 20px #fff; z-index: 100; }
        .controls { margin-bottom: 25px; text-align: center; }
        h1 { font-size: 3em; margin: 0; color: #00ff88; text-transform: uppercase; letter-spacing: 5px; text-shadow: 0 0 20px #00ff88; }
        button { padding: 18px 55px; font-size: 24px; cursor: pointer; background: #00ff88; color: #000; border: none; border-radius: 10px; font-weight: 900; transition: 0.3s; text-transform: uppercase; }
        button:hover { transform: scale(1.1); box-shadow: 0 0 40px rgba(0,255,136,0.6); }
        #status { margin-top: 20px; font-size: 1.5em; font-weight: bold; color: #00ff88; font-style: italic; }
    </style>
</head>
<body>
    <div class="controls">
        <h1>CARO SÁT THỦ V14</h1>
        <button id="startBtn">GIAO CHIẾN</button>
        <div id="status">V14: Phục hồi 100% logic, không rút gọn!</div>
    </div>
    <div id="board"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";

        const firebaseConfig = { databaseURL: "https://carovippro-default-rtdb.firebaseio.com/" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const SIZE = 12;
        let board = [], history = [], isGameOver = true;
        let urgentMoves = []; 

        // --- HÀM QUÉT LIÊN TỤC 20 TPS (GHÉP THÊM VÀO) ---
        setInterval(() => {
            if (isGameOver) return;
            urgentMoves = [];
            for (let r=0; r<SIZE; r++) {
                for (let c=0; c<SIZE; c++) {
                    if (!board[r][c]) {
                        // Quét phòng thủ: ưu tiên hàng 4 và hàng 3 hở của Player
                        let def = getTacticalScore(r, c, 1, 0, 'X') + 
                                  getTacticalScore(r, c, 0, 1, 'X') + 
                                  getTacticalScore(r, c, 1, 1, 'X') + 
                                  getTacticalScore(r, c, 1, -1, 'X');
                        if (def >= 800000000) urgentMoves.push({r, c});
                    }
                }
            }
        }, 50);

        function initBoard() {
            board = Array(SIZE).fill(null).map(() => Array(SIZE).fill(null));
            const b = document.getElementById('board'); b.innerHTML = '';
            for (let r=0; r<SIZE; r++) {
                for (let c=0; c<SIZE; c++) {
                    const el = document.createElement('div');
                    el.className = 'cell'; el.id = `c-${r}-${c}`;
                    el.onclick = () => playerMove(r, c);
                    b.appendChild(el);
                }
            }
        }

        window.playerMove = (r, c) => {
            if (isGameOver || board[r][c]) return;
            makeMove(r, c, 'X');
            if (checkWin(r, c, 'X')) { endGame("V14: BRO QUÁ KHỦNG!"); }
            else { document.getElementById('status').innerText = "V14 đang soi bẫy..."; setTimeout(botMove, 150); }
        };

        function botMove() {
            if (isGameOver) return;
            let bestScore = -Infinity, move = null;

            if (urgentMoves.length > 0) {
                move = urgentMoves[0];
            } else {
                for (let r=0; r<SIZE; r++) {
                    for (let c=0; c<SIZE; c++) {
                        if (!board[r][c]) {
                            // SỬ DỤNG LẠI TOÀN BỘ HÀM PHÂN TÍCH CHI TIẾT GỐC
                            let score = analyzeDetailed(r, c);
                            if (score > bestScore) { bestScore = score; move = {r, c}; }
                        }
                    }
                }
            }

            if (move) {
                makeMove(move.r, move.c, 'O');
                if (checkWin(move.r, move.c, 'O')) { endGame("Bot thắng! Quá non."); }
                else { document.getElementById('status').innerText = "Đến lượt m đó!"; }
            }
        }

        // --- PHỤC HỒI HÀM CHI TIẾT DÀI DẰNG DẶC ---
        function analyzeDetailed(r, c) {
            let totalScore = Math.random() * 1500;
            const directions = [[1,0], [0,1], [1,1], [1,-1]];
            let threatsX = 0, threatsO = 0;
            directions.forEach(([dr, dc]) => {
                let attack = getTacticalScore(r, c, dr, dc, 'O');
                let defense = getTacticalScore(r, c, dr, dc, 'X');
                if (attack >= 10000000) threatsO++;
                if (defense >= 10000000) threatsX++;
                totalScore += attack + defense * 7.0; 
            });
            if (threatsX >= 2) totalScore += 500000000; 
            if (threatsO >= 2) totalScore += 450000000; 
            for(let i=-2; i<=2; i++){
                for(let j=-2; j<=2; j++){
                    let nr=r+i, nc=c+j;
                    if(nr>=0 && nr<SIZE && nc>=0 && nc<SIZE && board[nr][nc]) totalScore += 20000;
                }
            }
            return totalScore;
        }

        function getTacticalScore(r, c, dr, dc, p) {
            let count = 0, open = 0, gap = 0, remote = 0, knight = 0;
            [[dr, dc], [-dr, -dc]].forEach(([tr, tc]) => {
                let nr = r + tr, nc = c + tc;
                while(nr>=0 && nr<SIZE && nc>=0 && nc<SIZE && board[nr][nc] === p) { count++; nr+=tr; nc+=tc; }
                if(nr>=0 && nr<SIZE && nc>=0 && nc<SIZE && !board[nr][nc]) {
                    open++;
                    let nr2 = nr + tr, nc2 = nc + tc;
                    if(nr2>=0 && nr2<SIZE && nc2>=0 && nc2<SIZE && board[nr2][nc2] === p) gap++;
                    let nr3 = nr2 + tr, nc3 = nc2 + tc;
                    if(nr3>=0 && nr3<SIZE && nc3>=0 && nc3<SIZE && board[nr3][nc3] === p) remote++;
                }
            });
            [[2,1],[1,2],[-1,2],[-2,1],[-2,-1],[-1,-2],[1,-2],[2,-1]].forEach(([kr, kc]) => {
                let nr=r+kr, nc=c+kc;
                if(nr>=0 && nr<SIZE && nc>=0 && nc<SIZE && board[nr][nc] === p) knight++;
            });
            if (count >= 4) return 1000000000; 
            if (count === 3 && open === 2) return 900000000; 
            if (count === 3 && open === 1) return 150000000; 
            if (gap >= 1 && count >= 2) return 90000000; 
            if (knight >= 1 && count >= 1) return 70000000; 
            if (remote >= 1) return 30000000; 
            return count * 80000 + gap * 150000 + knight * 120000;
        }

        function makeMove(r, c, p) {
            board[r][c] = p; history.push({r, c, p});
            document.querySelectorAll('.cell').forEach(el => el.classList.remove('last-move'));
            const el = document.getElementById(`c-${r}-${c}`);
            el.innerText = p; el.classList.add(p, 'last-move');
        }

        function checkWin(r, c, p) {
            return [[1,0], [0,1], [1,1], [1,-1]].some(([dr, dc]) => {
                let cnt = 1;
                [[dr, dc], [-dr, -dc]].forEach(([tr, tc]) => {
                    let nr = r+tr, nc = c+tc;
                    while(nr>=0 && nr<SIZE && nc>=0 && nc<SIZE && board[nr][nc] === p) { cnt++; nr+=tr; nc+=tc; }
                });
                return cnt >= 5;
            });
        }

        function endGame(msg) { isGameOver = true; document.getElementById('status').innerText = msg; }
        document.getElementById('startBtn').onclick = () => { isGameOver = false; history = []; initBoard(); document.getElementById('status').innerText = "V14: CHIẾN!"; };
    </script>
</body>
</html>
