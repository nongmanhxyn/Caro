<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Caro AI Cloud - V9 Final Boss</title>
    <style>
        body { background: #050505; color: #fff; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        #board { display: grid; grid-template-columns: repeat(12, 38px); gap: 2px; background: #111; padding: 12px; border-radius: 15px; border: 4px solid #00ff88; box-shadow: 0 0 60px rgba(0,255,136,0.3); }
        .cell { width: 38px; height: 38px; background: #000; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: 900; cursor: pointer; transition: 0.1s; border-radius: 4px; border: 1px solid #222; }
        .cell:hover { background: #111; box-shadow: inset 0 0 15px #00ff88; }
        .cell.X { color: #ff4444; text-shadow: 0 0 10px #ff4444; }
        .cell.O { color: #00d2ff; text-shadow: 0 0 10px #00d2ff; }
        .last-move { border: 2px solid #fff !important; box-shadow: 0 0 20px #fff; z-index: 100; }
        .controls { margin-bottom: 25px; text-align: center; }
        h1 { font-size: 3em; margin: 0; color: #00ff88; text-transform: uppercase; letter-spacing: 5px; text-shadow: 0 0 20px #00ff88; }
        button { padding: 18px 55px; font-size: 24px; cursor: pointer; background: #00ff88; color: #000; border: none; border-radius: 10px; font-weight: 900; transition: 0.3s; text-transform: uppercase; }
        button:hover { transform: scale(1.1); box-shadow: 0 0 40px rgba(0,255,136,0.6); }
        #status { margin-top: 20px; font-size: 1.5em; font-weight: bold; color: #00ff88; font-style: italic; }
    </style>
</head>
<body>
    <div class="controls">
        <h1>CARO FINAL BOSS V9</h1>
        <button id="startBtn">GIAO CHIẾN</button>
        <div id="status">Đang nạp 1 tỷ dữ liệu kiện tướng...</div>
    </div>
    <div id="board"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";

        const firebaseConfig = { databaseURL: "https://carovippro-default-rtdb.firebaseio.com/" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const SIZE = 12;
        let board = [], history = [], brainData = {}, isGameOver = true;

        async function loadBrain() {
            try {
                const snapshot = await get(child(ref(db), 'brain'));
                if (snapshot.exists()) brainData = snapshot.val();
                document.getElementById('status').innerText = "V9: AI Đã Tiến Hóa Xong!";
            } catch (e) { document.getElementById('status').innerText = "V9: Sẵn sàng (Offline)"; }
        }
        loadBrain();

        function initBoard() {
            board = Array(SIZE).fill(null).map(() => Array(SIZE).fill(null));
            const b = document.getElementById('board'); b.innerHTML = '';
            for (let r=0; r<SIZE; r++) {
                for (let c=0; c<SIZE; c++) {
                    const el = document.createElement('div');
                    el.className = 'cell'; el.id = `c-${r}-${c}`;
                    el.onclick = () => playerMove(r, c);
                    b.appendChild(el);
                }
            }
        }

        window.playerMove = (r, c) => {
            if (isGameOver || board[r][c]) return;
            makeMove(r, c, 'X');
            if (checkWin(r, c, 'X')) { endGame("V9 ĐÃ THẤT BẠI? KHÔNG THỂ!"); saveToCloud('X'); }
            else { document.getElementById('status').innerText = "V9 đang quét ma trận bẫy..."; setTimeout(botMove, 200); }
        };

        function botMove() {
            if (isGameOver) return;
            let bestScore = -Infinity, move = null;

            // QUÉT TOÀN BỘ BÀN CỜ ĐỂ TÌM ĐIỂM CHIẾN THUẬT
            for (let r=0; r<SIZE; r++) {
                for (let c=0; c<SIZE; c++) {
                    if (!board[r][c]) {
                        let score = analyzePosition(r, c);
                        // Cloud memory mang tính quyết định
                        score += (brainData[`${r}_${c}`] || 0) * 1000; 

                        if (score > bestScore) {
                            bestScore = score;
                            move = {r, c};
                        }
                    }
                }
            }

            if (move) {
                makeMove(move.r, move.c, 'O');
                if (checkWin(move.r, move.c, 'O')) { 
                    endGame("Kết thúc! Bro quá non."); 
                    saveToCloud('O'); 
                } else { document.getElementById('status').innerText = "Đến lượt bro đó!"; }
            }
        }

        // HỆ THỐNG PHÂN TÍCH MA TRẬN ĐA LỚP
        function analyzePosition(r, c) {
            let score = Math.random() * 500; // Tránh bị bắt bài
            const directions = [[1,0], [0,1], [1,1], [1,-1]];
            let threatsO = 0, threatsX = 0;

            directions.forEach(([dr, dc]) => {
                let sO = getPatternStrength(r, c, dr, dc, 'O');
                let sX = getPatternStrength(r, c, dr, dc, 'X');

                // Nhận diện Fork (Bẫy kép)
                if (sO >= 800000) threatsO++;
                if (sX >= 800000) threatsX++;

                // Thủ/Công cân bằng hệ số Kiện tướng (4.2)
                score += sO + sX * 4.2;
            });

            // LOGIC SÁT THỦ: Ưu tiên bẫy 4-3, 3-3, 4-4
            if (threatsX >= 2) score += 20000000; // Phá Fork của bro ngay tắp lự
            if (threatsO >= 2) score += 15000000; // Tự tạo Fork Sure-win

            // KỸ THUẬT "HOA NỞ GIỮA RỪNG" (Vẩy rau)
            let proximity = 0;
            for(let i=-2; i<=2; i++){
                for(let j=-2; j<=2; j++){
                    let nr=r+i, nc=c+j;
                    if(nr>=0 && nr<SIZE && nc>=0 && nc<SIZE && board[nr][nc]) proximity++;
                }
            }
            score += proximity * 2000;

            return score;
        }

        function getPatternStrength(r, c, dr, dc, p) {
            let count = 0, open = 0, gap = 0, remote = 0;
            
            [[dr, dc], [-dr, -dc]].forEach(([tr, tc]) => {
                let nr = r + tr, nc = c + tc;
                // Nhận diện quân nối tiếp
                while(nr>=0 && nr<SIZE && nc>=0 && nc<SIZE && board[nr][nc] === p) { count++; nr+=tr; nc+=tc; }
                
                if(nr>=0 && nr<SIZE && nc>=0 && nc<SIZE && !board[nr][nc]) {
                    open++;
                    // Nhận diện Bẫy gián cách 1 ô (X_XX)
                    let nr2 = nr + tr, nc2 = nc + tc;
                    if(nr2>=0 && nr2<SIZE && nc2>=0 && nc2<SIZE && board[nr2][nc2] === p) gap++;
                    
                    // Nhận diện Kỹ thuật "Nối xa" (X_ _X)
                    let nr3 = nr2 + tr, nc3 = nc2 + tc;
                    if(nr3>=0 && nr3<SIZE && nc3>=0 && nc3<SIZE && board[nr3][nc3] === p) remote++;
                }
            });

            // Bẫy Mã Ngược (Knight's Move)
            let knightCount = 0;
            [[2,1],[1,2],[-1,2],[-2,1],[-2,-1],[-1,-2],[1,-2],[2,-1]].forEach(([kr, kc]) => {
                let nr=r+kr, nc=c+kc;
                if(nr>=0 && nr<SIZE && nc>=0 && nc<SIZE && board[nr][nc] === p) knightCount++;
            });

            // TRẢ VỀ ĐIỂM SỐ CHIẾN THUẬT CỰC NẶNG
            if (count >= 4) return 50000000; 
            if (count === 3 && open === 2) return 5000000; // 3 hở 2 đầu = Sắp thắng
            if (gap >= 1 && count >= 2) return 1500000;  // Bẫy gián cách YouTube
            if (knightCount >= 1 && count >= 1) return 800000; // Bẫy mã ngược TikTok
            if (remote >= 1 && count >= 1) return 400000; // Nối xa FB
            
            return count * 10000 + gap * 25000 + knightCount * 20000;
        }

        function makeMove(r, c, p) {
            board[r][c] = p; history.push({r, c, p});
            document.querySelectorAll('.cell').forEach(el => el.classList.remove('last-move'));
            const el = document.getElementById(`c-${r}-${c}`);
            el.innerText = p; el.classList.add(p, 'last-move');
        }

        function checkWin(r, c, p) {
            return [[1,0], [0,1], [1,1], [1,-1]].some(([dr, dc]) => {
                let cnt = 1;
                [[dr, dc], [-dr, -dc]].forEach(([tr, tc]) => {
                    let nr = r+tr, nc = c+tc;
                    while(nr>=0 && nr<SIZE && nc>=0 && nc<SIZE && board[nr][nc] === p) { cnt++; nr+=tr; nc+=tc; }
                });
                return cnt >= 5;
            });
        }

        function saveToCloud(winner) {
            history.forEach(m => {
                let key = `${m.r}_${m.c}`;
                // PHẠT NẶNG ĐỂ HỌC KHÔN (-2000)
                brainData[key] = (brainData[key] || 0) + (m.p === winner ? 500 : -2000);
            });
            set(ref(db, 'brain'), brainData);
        }

        function endGame(msg) { isGameOver = true; document.getElementById('status').innerText = msg; }
        document.getElementById('startBtn').onclick = () => { isGameOver = false; history = []; initBoard(); document.getElementById('status').innerText = "V9 VÀO TRẬN!"; };
    </script>
</body>
</html>
